<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://JRF63.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://JRF63.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://JRF63.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://JRF63.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://JRF63.github.io/css/light.css' />
    <link rel="stylesheet" href='https://JRF63.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://JRF63.github.io/css/syntax.css' />
    <link rel="stylesheet" href='https://JRF63.github.io/css/base.css' />
    <title>Exploring fast-math in Rust: Part 1 - Global -Z flag - JRF63.github.io</title>
    <link rel="icon" type="image/x-icon" href='https://JRF63.github.io/images/favicon.ico'>
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="#twocol { position: relative; display: flex; margin-bottom: 15px; overflow-y: hidden; } .closed { height: 700px; transition: height 0.8s ease-in-out; } .expanded { height: 2455px; } #subcol { flex: 1 1; overflow-x: hidden; overflow-y: hidden; } #subcol  figure, #subcol  figure  pre { margin-bottom: 0px; scrollbar-width: none; } #subcol  figure  pre::-webkit-scrollbar { display: none; } #divider { flex-basis: 4px; } #button { position: absolute; left: 0%; bottom: 0%; width: 100%; border: none; outline: none; height: 30px; background: linear-gradient(to top, #cccccc, Transparent); opacity: 0." />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://JRF63.github.io/posts/rust-fast-math/pt1/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Exploring fast-math in Rust: Part 1 - Global -Z flag - JRF63.github.io" />
<meta name="twitter:description"
  content="#twocol { position: relative; display: flex; margin-bottom: 15px; overflow-y: hidden; } .closed { height: 700px; transition: height 0.8s ease-in-out; } .expanded { height: 2455px; } #subcol { flex: 1 1; overflow-x: hidden; overflow-y: hidden; } #subcol  figure, #subcol  figure  pre { margin-bottom: 0px; scrollbar-width: none; } #subcol  figure  pre::-webkit-scrollbar { display: none; } #divider { flex-basis: 4px; } #button { position: absolute; left: 0%; bottom: 0%; width: 100%; border: none; outline: none; height: 30px; background: linear-gradient(to top, #cccccc, Transparent); opacity: 0." />
<meta name="twitter:site" content="https://JRF63.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://JRF63.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="Exploring fast-math in Rust: Part 1 - Global -Z flag - JRF63.github.io">
<meta property="og:description"
  content="#twocol { position: relative; display: flex; margin-bottom: 15px; overflow-y: hidden; } .closed { height: 700px; transition: height 0.8s ease-in-out; } .expanded { height: 2455px; } #subcol { flex: 1 1; overflow-x: hidden; overflow-y: hidden; } #subcol  figure, #subcol  figure  pre { margin-bottom: 0px; scrollbar-width: none; } #subcol  figure  pre::-webkit-scrollbar { display: none; } #divider { flex-basis: 4px; } #button { position: absolute; left: 0%; bottom: 0%; width: 100%; border: none; outline: none; height: 30px; background: linear-gradient(to top, #cccccc, Transparent); opacity: 0." />
<meta property="og:url" content="https://JRF63.github.io/posts/rust-fast-math/pt1/" />
<meta property="og:site_name" content="Exploring fast-math in Rust: Part 1 - Global -Z flag" />
<meta property="og:image"
  content="https://JRF63.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-12-16 11:00:00 &#43;0800 &#43;08" />










</head>

<body>
  <div>
  <header class="header-wrapper">
    <div class="header-container">
      <div class="header-dummy"></div>
      <div class="title-container">
        <a class="link" href="https://JRF63.github.io/">
          <span class="site-title">JRF63.github.io</span>
        </a>
      </div>
      <div class="header-menu">
        <div class="slider-slot">
          <div class="slider" onclick="switchTheme()">
            <svg style="fill: var(--color-profile-color-modes-toggle-moon); margin: 7px 0 0 7px;" width="14"
              height="13" viewBox="0 0 14 13" xmlns="http://www.w3.org/2000/svg" >
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
              </path>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </header>
</div>
  
<div class="main-wrapper">
  <main class="main-content">
    <div class="post-header">
      <div class="post-info">
        <div class="post-date">December 16, 2020</div>
        <div class="post-tags">
          <div></div>
          
          
          <a class="post-tag link" href="/tags/rust">
            Rust
          </a>
          
          <a class="post-tag link" href="/tags/fast-math">
            fast-math
          </a>
          
          
        </div>
      </div>
      <h1 class="post-title">Exploring fast-math in Rust: Part 1 - Global -Z flag</h1>
    </div>
    <article class="markdown-body article-wrapper"><style type="text/css">
#twocol {
    position: relative;
    display: flex;
    margin-bottom: 15px;
    overflow-y: hidden;
}

.closed {
    height: 700px;
    transition: height 0.8s ease-in-out;
}

.expanded {
    height: 2455px;
}

#subcol {
    flex: 1 1;
    overflow-x: hidden;
    overflow-y: hidden;
}

#subcol > figure, #subcol > figure > pre {
    margin-bottom: 0px;
    scrollbar-width: none;
}

#subcol > figure > pre::-webkit-scrollbar {
    display: none;
}

#divider {
    flex-basis: 4px;
}

#button {
    position: absolute;
    left: 0%;
    bottom: 0%;
    width: 100%;
    border: none;
    outline: none;
    height: 30px;
    background: linear-gradient(to top, #cccccc, Transparent);
    opacity: 0.8;
    font-size: 14;
}
</style>
<p>TL;DR <a href="https://github.com/JRF63/rust/tree/fastmath-flag">This branch</a> on my fork.</p>
<h2 id="quick-and-dirty">Quick and dirty</h2>
<p>Creating a flag to enable fast-math is surprisingly not that hard. We first repurpose 

    
    
        
        
        
        
    
    

<code class="language-rust" data-lang="rust"><span class="nf">LLVMRustSetHasUnsafeAlgebra</span></code> to do a check if the instruction passed to it is an 

    
    
        
        
        
        
    
    

<code class="language-cpp" data-lang="cpp"><span class="nc">FPMathOperator</span></code> so that we can use it for 

    
    
        
        
        
        
    
    

<code class="language-rust" data-lang="rust"><span class="nf">phi</span></code>, 

    
    
        
        
        
        
    
    

<code class="language-rust" data-lang="rust"><span class="nf">select</span></code> and 

    
    
        
        
        
        
    
    

<code class="language-rust" data-lang="rust"><span class="nf">call</span></code> without bothering non-floats:</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff"><span class="gd">--- a/compiler/rustc_llvm/llvm-wrapper/RustWrapper.cpp
</span><span class="gd"></span><span class="gi">+++ b/compiler/rustc_llvm/llvm-wrapper/RustWrapper.cpp
</span><span class="gi"></span>
 extern &#34;C&#34; void LLVMRustSetHasUnsafeAlgebra(LLVMValueRef V) {
<span class="gd">-  if (auto I = dyn_cast&lt;Instruction&gt;(unwrap&lt;Value&gt;(V))) {
</span><span class="gd">-    I-&gt;setFast(true);
</span><span class="gd"></span><span class="gi">+  Value *Ptr = unwrap(V);
</span><span class="gi">+  if (isa&lt;FPMathOperator&gt;(Ptr)) {
</span><span class="gi">+    if (auto I = dyn_cast&lt;Instruction&gt;(Ptr)) {
</span><span class="gi">+      I-&gt;setFast(true);
</span><span class="gi">+    }
</span><span class="gi"></span>   }
 }
</code></pre></div>
<p>Presupposing we already coded in the flag, we just slap 

    
    
        
        
        
        
    
    

<code class="language-rust" data-lang="rust"><span class="nf">LLVMRustSetHasUnsafeAlgebra</span></code> on each of the float operations and 

    
    
        
        
        
        
    
    

<code class="language-rust" data-lang="rust"><span class="nf">phi</span></code>, 

    
    
        
        
        
        
    
    

<code class="language-rust" data-lang="rust"><span class="nf">select</span></code> and 

    
    
        
        
        
        
    
    

<code class="language-rust" data-lang="rust"><span class="nf">call</span></code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cx</span><span class="p">().</span><span class="n">sess</span><span class="p">().</span><span class="n">opts</span><span class="p">.</span><span class="n">debugging_opts</span><span class="p">.</span><span class="n">fast_fp_math</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">llvm</span>::<span class="n">LLVMRustSetHasUnsafeAlgebra</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>And done. Just a couple of lines. If you don&rsquo;t care about build time that is. The process outlined above checks the flag for each instruction we want to modify. We want to check the flag first and only <em>once</em>; then apply the modifications so we don&rsquo;t negatively impact builds that don&rsquo;t use the fast-math flag.</p>
<h2 id="something-smarter">Something smarter</h2>
<p>What the goal here boils down to is: inspecting all instructions and setting the fast-math flag as necessary. The coarsest unit of the LLVM IR is a <a href="https://llvm.org/docs/LangRef.html#module-structure">module</a> each of which consists of functions among other things we don&rsquo;t care about. <a href="https://llvm.org/docs/LangRef.html#functions">Functions</a> in turn are composed of basic blocks plus other things we also don&rsquo;t care about. And the instructions are in those basic blocks.</p>
<p>In other words, walking from LLVM module to individual instructions in <del>pseudo</del> real code should be:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="kt">void</span> <span class="n">LLVMRustApplyFastMath</span><span class="p">(</span><span class="n">LLVMModuleRef</span> <span class="n">M</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">Function</span> <span class="o">&amp;</span><span class="nl">F</span><span class="p">:</span> <span class="n">unwrap</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getFunctionList</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">BasicBlock</span> <span class="o">&amp;</span><span class="nl">BB</span><span class="p">:</span> <span class="n">F</span><span class="p">.</span><span class="n">getBasicBlockList</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">Instruction</span> <span class="o">&amp;</span><span class="nl">I</span><span class="p">:</span> <span class="n">BB</span><span class="p">.</span><span class="n">getInstList</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">FPMathOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">I</span><span class="p">.</span><span class="n">setFast</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The only other problem is where to call this in the codegen. The constraints are that this should be called after the module is completely defined so the instructions are in their place but before the optimization passes so that the passes could make use of the fast-math flags. I chose <a href="https://github.com/JRF63/rust/blob/fastmath-flag/compiler/rustc_codegen_llvm/src/base.rs#L146">this part</a> to also be able to easily check the <code>-Z</code> flag.</p>
<p>Better yet, you could just ignore all this and just checkout <a href="https://github.com/JRF63/rust/tree/fastmath-flag">this branch</a> on my fork. I even added-in the individual flags of fast-math since I was complaining about it in Part 0.</p>
<h2 id="sanity-check">Sanity check</h2>
<p>Directly translating the example in Part 0 from C to Rust and using the freshly minted <code>-Z</code> flag:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">summation</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kt">f32</span> <span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="n">sum</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>Output:</p>
<div id="twocol" class="closed">
<div id="subcol">
<div class="highlight"><pre class="chroma"><code class="language-llvm" data-lang="llvm"><span class="c">; cargo +fastmath rustc --release -- -Z fp_math=fast --emit=llvm-ir
</span><span class="c"></span><span class="k">define</span> <span class="kt">float</span> <span class="vg">@summation</span><span class="p">([</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">]*</span> <span class="k">noalias</span> <span class="k">nocapture</span> <span class="k">nonnull</span> <span class="k">readonly</span> <span class="k">align</span> <span class="m">4</span> <span class="nv">%x.0</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%x.1</span><span class="p">)</span> <span class="k">unnamed_addr</span> <span class="vg">#0</span> <span class="k">personality</span> <span class="k">i32</span> <span class="p">(...)*</span> <span class="vg">@__CxxFrameHandler3</span> <span class="p">{</span>
<span class="nl">start:</span>
  <span class="nv">%.not</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="nv">%x.1</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="nv">%.not</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb5</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb8.preheader</span>

<span class="nl">bb8.preheader:</span>                                    <span class="c">; preds = %start
</span><span class="c"></span>  <span class="nv">%min.iters.check</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">ult</span> <span class="k">i64</span> <span class="nv">%x.1</span><span class="p">,</span> <span class="m">8</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="nv">%min.iters.check</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb8.preheader18</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%vector.ph</span>

<span class="nl">bb8.preheader18:</span>                                  <span class="c">; preds = %middle.block, %bb8.preheader
</span><span class="c"></span>  <span class="nv">%sum.015.ph</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">float</span> <span class="p">[</span> <span class="m">0.000000e+00</span><span class="p">,</span> <span class="nv">%bb8.preheader</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%34</span><span class="p">,</span> <span class="nv">%middle.block</span> <span class="p">]</span>
  <span class="nv">%iter.sroa.0.014.ph</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="nv">%bb8.preheader</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%n.vec</span><span class="p">,</span> <span class="nv">%middle.block</span> <span class="p">]</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb8</span>

<span class="nl">vector.ph:</span>                                        <span class="c">; preds = %bb8.preheader
</span><span class="c"></span>  <span class="nv">%n.vec</span> <span class="p">=</span> <span class="k">and</span> <span class="k">i64</span> <span class="nv">%x.1</span><span class="p">,</span> <span class="m">-8</span>
  <span class="n">%0</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="nv">%n.vec</span><span class="p">,</span> <span class="m">-8</span>
  <span class="n">%1</span> <span class="p">=</span> <span class="k">lshr</span> <span class="k">exact</span> <span class="k">i64</span> <span class="n">%0</span><span class="p">,</span> <span class="m">3</span>
  <span class="n">%2</span> <span class="p">=</span> <span class="k">add</span> <span class="k">nuw</span> <span class="k">nsw</span> <span class="k">i64</span> <span class="n">%1</span><span class="p">,</span> <span class="m">1</span>
  <span class="nv">%xtraiter</span> <span class="p">=</span> <span class="k">and</span> <span class="k">i64</span> <span class="n">%2</span><span class="p">,</span> <span class="m">3</span>
  <span class="n">%3</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">ult</span> <span class="k">i64</span> <span class="n">%0</span><span class="p">,</span> <span class="m">24</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="n">%3</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%middle.block.unr-lcssa</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%vector.ph.new</span>

<span class="nl">vector.ph.new:</span>                                    <span class="c">; preds = %vector.ph
</span><span class="c"></span>  <span class="nv">%unroll_iter</span> <span class="p">=</span> <span class="k">and</span> <span class="k">i64</span> <span class="n">%2</span><span class="p">,</span> <span class="m">4611686018427387900</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%vector.body</span>

<span class="nl">vector.body:</span>                                      <span class="c">; preds = %vector.body, %vector.ph.new
</span><span class="c"></span>  <span class="nv">%index</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="nv">%vector.ph.new</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%index.next.3</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv">%vec.phi</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">zeroinitializer</span><span class="p">,</span> <span class="nv">%vector.ph.new</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%26</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv">%vec.phi16</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">zeroinitializer</span><span class="p">,</span> <span class="nv">%vector.ph.new</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%27</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv">%niter</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="nv">%unroll_iter</span><span class="p">,</span> <span class="nv">%vector.ph.new</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%niter.nsub.3</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="n">%4</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">],</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">]*</span> <span class="nv">%x.0</span><span class="p">,</span> <span class="k">i64</span> <span class="m">0</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%index</span>
  <span class="n">%5</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%4</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%5</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%6</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%4</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%7</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%6</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load17</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%7</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%8</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load</span><span class="p">,</span> <span class="nv">%vec.phi</span>
  <span class="n">%9</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load17</span><span class="p">,</span> <span class="nv">%vec.phi16</span>
  <span class="nv">%index.next</span> <span class="p">=</span> <span class="k">or</span> <span class="k">i64</span> <span class="nv">%index</span><span class="p">,</span> <span class="m">8</span>
  <span class="n">%10</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">],</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">]*</span> <span class="nv">%x.0</span><span class="p">,</span> <span class="k">i64</span> <span class="m">0</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%index.next</span>
  <span class="n">%11</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%10</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load.1</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%11</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%12</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%10</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%13</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%12</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load17.1</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%13</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%14</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load.1</span><span class="p">,</span> <span class="n">%8</span>
  <span class="n">%15</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load17.1</span><span class="p">,</span> <span class="n">%9</span>
  <span class="nv">%index.next.1</span> <span class="p">=</span> <span class="k">or</span> <span class="k">i64</span> <span class="nv">%index</span><span class="p">,</span> <span class="m">16</span>
  <span class="n">%16</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">],</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">]*</span> <span class="nv">%x.0</span><span class="p">,</span> <span class="k">i64</span> <span class="m">0</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%index.next.1</span>
  <span class="n">%17</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%16</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load.2</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%17</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%18</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%16</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%19</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%18</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load17.2</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%19</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%20</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load.2</span><span class="p">,</span> <span class="n">%14</span>
  <span class="n">%21</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load17.2</span><span class="p">,</span> <span class="n">%15</span>
  <span class="nv">%index.next.2</span> <span class="p">=</span> <span class="k">or</span> <span class="k">i64</span> <span class="nv">%index</span><span class="p">,</span> <span class="m">24</span>
  <span class="n">%22</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">],</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">]*</span> <span class="nv">%x.0</span><span class="p">,</span> <span class="k">i64</span> <span class="m">0</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%index.next.2</span>
  <span class="n">%23</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%22</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load.3</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%23</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%24</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%22</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%25</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%24</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load17.3</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%25</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%26</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load.3</span><span class="p">,</span> <span class="n">%20</span>
  <span class="n">%27</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load17.3</span><span class="p">,</span> <span class="n">%21</span>
  <span class="nv">%index.next.3</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="nv">%index</span><span class="p">,</span> <span class="m">32</span>
  <span class="nv">%niter.nsub.3</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="nv">%niter</span><span class="p">,</span> <span class="m">-4</span>
  <span class="nv">%niter.ncmp.3</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="nv">%niter.nsub.3</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="nv">%niter.ncmp.3</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%middle.block.unr-lcssa</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%vector.body</span><span class="p">,</span> <span class="nv">!llvm.loop</span> <span class="n">!11</span>

<span class="nl">middle.block.unr-lcssa:</span>                           <span class="c">; preds = %vector.body, %vector.ph
</span><span class="c"></span>  <span class="nv">%.lcssa20.ph</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">undef</span><span class="p">,</span> <span class="nv">%vector.ph</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%26</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv">%.lcssa19.ph</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">undef</span><span class="p">,</span> <span class="nv">%vector.ph</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%27</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv">%index.unr</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="nv">%vector.ph</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%index.next.3</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv">%vec.phi.unr</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">zeroinitializer</span><span class="p">,</span> <span class="nv">%vector.ph</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%26</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv">%vec.phi16.unr</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">zeroinitializer</span><span class="p">,</span> <span class="nv">%vector.ph</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%27</span><span class="p">,</span> <span class="nv">%vector.body</span> <span class="p">]</span>
  <span class="nv">%lcmp.mod.not</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="nv">%xtraiter</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="nv">%lcmp.mod.not</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%middle.block</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%vector.body.epil</span>

<span class="nl">vector.body.epil:</span>                                 <span class="c">; preds = %middle.block.unr-lcssa, %vector.body.epil
</span><span class="c"></span>  <span class="nv">%index.epil</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="nv">%index.next.epil</span><span class="p">,</span> <span class="nv">%vector.body.epil</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%index.unr</span><span class="p">,</span> <span class="nv">%middle.block.unr-lcssa</span> <span class="p">]</span>
  <span class="nv">%vec.phi.epil</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="n">%32</span><span class="p">,</span> <span class="nv">%vector.body.epil</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%vec.phi.unr</span><span class="p">,</span> <span class="nv">%middle.block.unr-lcssa</span> <span class="p">]</span>
  <span class="nv">%vec.phi16.epil</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="n">%33</span><span class="p">,</span> <span class="nv">%vector.body.epil</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%vec.phi16.unr</span><span class="p">,</span> <span class="nv">%middle.block.unr-lcssa</span> <span class="p">]</span>
  <span class="nv">%epil.iter</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="nv">%epil.iter.sub</span><span class="p">,</span> <span class="nv">%vector.body.epil</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%xtraiter</span><span class="p">,</span> <span class="nv">%middle.block.unr-lcssa</span> <span class="p">]</span>
  <span class="n">%28</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">],</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">]*</span> <span class="nv">%x.0</span><span class="p">,</span> <span class="k">i64</span> <span class="m">0</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%index.epil</span>
  <span class="n">%29</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%28</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load.epil</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%29</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%30</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%28</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%31</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%30</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="nv">%wide.load17.epil</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%31</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%32</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load.epil</span><span class="p">,</span> <span class="nv">%vec.phi.epil</span>
  <span class="n">%33</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%wide.load17.epil</span><span class="p">,</span> <span class="nv">%vec.phi16.epil</span>
  <span class="nv">%index.next.epil</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="nv">%index.epil</span><span class="p">,</span> <span class="m">8</span>
  <span class="nv">%epil.iter.sub</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="nv">%epil.iter</span><span class="p">,</span> <span class="m">-1</span>
  <span class="nv">%epil.iter.cmp.not</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="nv">%epil.iter.sub</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="nv">%epil.iter.cmp.not</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%middle.block</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%vector.body.epil</span><span class="p">,</span> <span class="nv">!llvm.loop</span> <span class="n">!12</span>

<span class="nl">middle.block:</span>                                     <span class="c">; preds = %vector.body.epil, %middle.block.unr-lcssa
</span><span class="c"></span>  <span class="nv">%.lcssa20</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="nv">%.lcssa20.ph</span><span class="p">,</span> <span class="nv">%middle.block.unr-lcssa</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%32</span><span class="p">,</span> <span class="nv">%vector.body.epil</span> <span class="p">]</span>
  <span class="nv">%.lcssa19</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="nv">%.lcssa19.ph</span><span class="p">,</span> <span class="nv">%middle.block.unr-lcssa</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%33</span><span class="p">,</span> <span class="nv">%vector.body.epil</span> <span class="p">]</span>
  <span class="nv">%bin.rdx</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%.lcssa19</span><span class="p">,</span> <span class="nv">%.lcssa20</span>
  <span class="n">%34</span> <span class="p">=</span> <span class="k">call</span> <span class="k">fast</span> <span class="kt">float</span> <span class="vg">@llvm.experimental.vector.reduce.v2.fadd.f32.v4f32</span><span class="p">(</span><span class="kt">float</span> <span class="m">0.000000e+00</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nv">%bin.rdx</span><span class="p">)</span>
  <span class="nv">%cmp.n</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="nv">%n.vec</span><span class="p">,</span> <span class="nv">%x.1</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="nv">%cmp.n</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb5</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb8.preheader18</span>

<span class="nl">bb5:</span>                                              <span class="c">; preds = %bb8, %middle.block, %start
</span><span class="c"></span>  <span class="nv">%sum.0.lcssa</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">float</span> <span class="p">[</span> <span class="m">0.000000e+00</span><span class="p">,</span> <span class="nv">%start</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%34</span><span class="p">,</span> <span class="nv">%middle.block</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%37</span><span class="p">,</span> <span class="nv">%bb8</span> <span class="p">]</span>
  <span class="k">ret</span> <span class="kt">float</span> <span class="nv">%sum.0.lcssa</span>

<span class="nl">bb8:</span>                                              <span class="c">; preds = %bb8.preheader18, %bb8
</span><span class="c"></span>  <span class="nv">%sum.015</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">float</span> <span class="p">[</span> <span class="n">%37</span><span class="p">,</span> <span class="nv">%bb8</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%sum.015.ph</span><span class="p">,</span> <span class="nv">%bb8.preheader18</span> <span class="p">]</span>
  <span class="nv">%iter.sroa.0.014</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="n">%35</span><span class="p">,</span> <span class="nv">%bb8</span> <span class="p">],</span> <span class="p">[</span> <span class="nv">%iter.sroa.0.014.ph</span><span class="p">,</span> <span class="nv">%bb8.preheader18</span> <span class="p">]</span>
  <span class="n">%35</span> <span class="p">=</span> <span class="k">add</span> <span class="k">nuw</span> <span class="k">i64</span> <span class="nv">%iter.sroa.0.014</span><span class="p">,</span> <span class="m">1</span>
  <span class="n">%36</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">],</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">float</span><span class="p">]*</span> <span class="nv">%x.0</span><span class="p">,</span> <span class="k">i64</span> <span class="m">0</span><span class="p">,</span> <span class="k">i64</span> <span class="nv">%iter.sroa.0.014</span>
  <span class="nv">%_15</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%36</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
  <span class="n">%37</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="kt">float</span> <span class="nv">%_15</span><span class="p">,</span> <span class="nv">%sum.015</span>
  <span class="nv">%exitcond.not</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="n">%35</span><span class="p">,</span> <span class="nv">%x.1</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="nv">%exitcond.not</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb5</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb8</span><span class="p">,</span> <span class="nv">!llvm.loop</span> <span class="n">!14</span>
<span class="p">}</span></code></pre></div>
</div>
<div id="divider"></div>
<div id="subcol">
<div class="highlight"><pre class="chroma"><code class="language-llvm" data-lang="llvm"><span class="c">; clang src\main.c -O3 -ffast-math -S -emit-llvm -o target\release\deps\summation.ll
</span><span class="c"></span><span class="k">define</span> <span class="err">dso_local</span> <span class="kt">float</span> <span class="vg">@summation</span><span class="p">(</span><span class="kt">float</span><span class="p">*</span> <span class="k">nocapture</span> <span class="k">readonly</span> <span class="n">%0</span><span class="p">,</span> <span class="k">i64</span> <span class="n">%1</span><span class="p">)</span> <span class="k">local_unnamed_addr</span> <span class="vg">#0</span> <span class="p">{</span>
<span class="c">; 2:
</span><span class="c"></span>  <span class="n">%3</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="n">%1</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="n">%3</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%90</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%4</span>

<span class="m">4</span><span class="err">:</span>                                                <span class="c">; preds = %2
</span><span class="c"></span>  <span class="n">%5</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">ult</span> <span class="k">i64</span> <span class="n">%1</span><span class="p">,</span> <span class="m">8</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="n">%5</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%6</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%9</span>

<span class="m">6</span><span class="err">:</span>                                                <span class="c">; preds = %84, %4
</span><span class="c"></span>  <span class="n">%7</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="n">%4</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%10</span><span class="p">,</span> <span class="n">%84</span> <span class="p">]</span>
  <span class="n">%8</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">float</span> <span class="p">[</span> <span class="m">0.000000e+00</span><span class="p">,</span> <span class="n">%4</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%88</span><span class="p">,</span> <span class="n">%84</span> <span class="p">]</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="n">%92</span>

<span class="m">9</span><span class="err">:</span>                                                <span class="c">; preds = %4
</span><span class="c"></span>  <span class="n">%10</span> <span class="p">=</span> <span class="k">and</span> <span class="k">i64</span> <span class="n">%1</span><span class="p">,</span> <span class="m">-8</span>
  <span class="n">%11</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="n">%10</span><span class="p">,</span> <span class="m">-8</span>
  <span class="n">%12</span> <span class="p">=</span> <span class="k">lshr</span> <span class="k">exact</span> <span class="k">i64</span> <span class="n">%11</span><span class="p">,</span> <span class="m">3</span>
  <span class="n">%13</span> <span class="p">=</span> <span class="k">add</span> <span class="k">nuw</span> <span class="k">nsw</span> <span class="k">i64</span> <span class="n">%12</span><span class="p">,</span> <span class="m">1</span>
  <span class="n">%14</span> <span class="p">=</span> <span class="k">and</span> <span class="k">i64</span> <span class="n">%13</span><span class="p">,</span> <span class="m">3</span>
  <span class="n">%15</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">ult</span> <span class="k">i64</span> <span class="n">%11</span><span class="p">,</span> <span class="m">24</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="n">%15</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%61</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%16</span>

<span class="m">16</span><span class="err">:</span>                                               <span class="c">; preds = %9
</span><span class="c"></span>  <span class="n">%17</span> <span class="p">=</span> <span class="k">and</span> <span class="k">i64</span> <span class="n">%13</span><span class="p">,</span> <span class="m">4611686018427387900</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="n">%18</span>

<span class="m">18</span><span class="err">:</span>                                               <span class="c">; preds = %18, %16
</span><span class="c"></span>  <span class="n">%19</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="n">%16</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%58</span><span class="p">,</span> <span class="n">%18</span> <span class="p">]</span>
  <span class="n">%20</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">zeroinitializer</span><span class="p">,</span> <span class="n">%16</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%56</span><span class="p">,</span> <span class="n">%18</span> <span class="p">]</span>
  <span class="n">%21</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">zeroinitializer</span><span class="p">,</span> <span class="n">%16</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%57</span><span class="p">,</span> <span class="n">%18</span> <span class="p">]</span>
  <span class="n">%22</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="n">%17</span><span class="p">,</span> <span class="n">%16</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%59</span><span class="p">,</span> <span class="n">%18</span> <span class="p">]</span>
  <span class="n">%23</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%0</span><span class="p">,</span> <span class="k">i64</span> <span class="n">%19</span>
  <span class="n">%24</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%23</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%25</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%24</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%26</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%23</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%27</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%26</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%28</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%27</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%29</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%25</span><span class="p">,</span> <span class="n">%20</span>
  <span class="n">%30</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%28</span><span class="p">,</span> <span class="n">%21</span>
  <span class="n">%31</span> <span class="p">=</span> <span class="k">or</span> <span class="k">i64</span> <span class="n">%19</span><span class="p">,</span> <span class="m">8</span>
  <span class="n">%32</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%0</span><span class="p">,</span> <span class="k">i64</span> <span class="n">%31</span>
  <span class="n">%33</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%32</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%34</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%33</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%35</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%32</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%36</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%35</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%37</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%36</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%38</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%34</span><span class="p">,</span> <span class="n">%29</span>
  <span class="n">%39</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%37</span><span class="p">,</span> <span class="n">%30</span>
  <span class="n">%40</span> <span class="p">=</span> <span class="k">or</span> <span class="k">i64</span> <span class="n">%19</span><span class="p">,</span> <span class="m">16</span>
  <span class="n">%41</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%0</span><span class="p">,</span> <span class="k">i64</span> <span class="n">%40</span>
  <span class="n">%42</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%41</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%43</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%42</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%44</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%41</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%45</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%44</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%46</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%45</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%47</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%43</span><span class="p">,</span> <span class="n">%38</span>
  <span class="n">%48</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%46</span><span class="p">,</span> <span class="n">%39</span>
  <span class="n">%49</span> <span class="p">=</span> <span class="k">or</span> <span class="k">i64</span> <span class="n">%19</span><span class="p">,</span> <span class="m">24</span>
  <span class="n">%50</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%0</span><span class="p">,</span> <span class="k">i64</span> <span class="n">%49</span>
  <span class="n">%51</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%50</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%52</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%51</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%53</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%50</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%54</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%53</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%55</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%54</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%56</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%52</span><span class="p">,</span> <span class="n">%47</span>
  <span class="n">%57</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%55</span><span class="p">,</span> <span class="n">%48</span>
  <span class="n">%58</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="n">%19</span><span class="p">,</span> <span class="m">32</span>
  <span class="n">%59</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="n">%22</span><span class="p">,</span> <span class="m">-4</span>
  <span class="n">%60</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="n">%59</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="n">%60</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%61</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%18</span><span class="p">,</span> <span class="nv">!llvm.loop</span> <span class="n">!7</span>

<span class="m">61</span><span class="err">:</span>                                               <span class="c">; preds = %18, %9
</span><span class="c"></span>  <span class="n">%62</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">undef</span><span class="p">,</span> <span class="n">%9</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%56</span><span class="p">,</span> <span class="n">%18</span> <span class="p">]</span>
  <span class="n">%63</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">undef</span><span class="p">,</span> <span class="n">%9</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%57</span><span class="p">,</span> <span class="n">%18</span> <span class="p">]</span>
  <span class="n">%64</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="n">%9</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%58</span><span class="p">,</span> <span class="n">%18</span> <span class="p">]</span>
  <span class="n">%65</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">zeroinitializer</span><span class="p">,</span> <span class="n">%9</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%56</span><span class="p">,</span> <span class="n">%18</span> <span class="p">]</span>
  <span class="n">%66</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="k">zeroinitializer</span><span class="p">,</span> <span class="n">%9</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%57</span><span class="p">,</span> <span class="n">%18</span> <span class="p">]</span>
  <span class="n">%67</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="n">%14</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="n">%67</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%84</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%68</span>

<span class="m">68</span><span class="err">:</span>                                               <span class="c">; preds = %61, %68
</span><span class="c"></span>  <span class="n">%69</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="n">%81</span><span class="p">,</span> <span class="n">%68</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%64</span><span class="p">,</span> <span class="n">%61</span> <span class="p">]</span>
  <span class="n">%70</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="n">%79</span><span class="p">,</span> <span class="n">%68</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%65</span><span class="p">,</span> <span class="n">%61</span> <span class="p">]</span>
  <span class="n">%71</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="n">%80</span><span class="p">,</span> <span class="n">%68</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%66</span><span class="p">,</span> <span class="n">%61</span> <span class="p">]</span>
  <span class="n">%72</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="n">%82</span><span class="p">,</span> <span class="n">%68</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%14</span><span class="p">,</span> <span class="n">%61</span> <span class="p">]</span>
  <span class="n">%73</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%0</span><span class="p">,</span> <span class="k">i64</span> <span class="n">%69</span>
  <span class="n">%74</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%73</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%75</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%74</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%76</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%73</span><span class="p">,</span> <span class="k">i64</span> <span class="m">4</span>
  <span class="n">%77</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%76</span> <span class="k">to</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span>
  <span class="n">%78</span> <span class="p">=</span> <span class="k">load</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;*</span> <span class="n">%77</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%79</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%75</span><span class="p">,</span> <span class="n">%70</span>
  <span class="n">%80</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%78</span><span class="p">,</span> <span class="n">%71</span>
  <span class="n">%81</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="n">%69</span><span class="p">,</span> <span class="m">8</span>
  <span class="n">%82</span> <span class="p">=</span> <span class="k">add</span> <span class="k">i64</span> <span class="n">%72</span><span class="p">,</span> <span class="m">-1</span>
  <span class="n">%83</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="n">%82</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="n">%83</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%84</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%68</span><span class="p">,</span> <span class="nv">!llvm.loop</span> <span class="n">!9</span>

<span class="m">84</span><span class="err">:</span>                                               <span class="c">; preds = %68, %61
</span><span class="c"></span>  <span class="n">%85</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="n">%62</span><span class="p">,</span> <span class="n">%61</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%79</span><span class="p">,</span> <span class="n">%68</span> <span class="p">]</span>
  <span class="n">%86</span> <span class="p">=</span> <span class="k">phi</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="p">[</span> <span class="n">%63</span><span class="p">,</span> <span class="n">%61</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%80</span><span class="p">,</span> <span class="n">%68</span> <span class="p">]</span>
  <span class="n">%87</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%86</span><span class="p">,</span> <span class="n">%85</span>
  <span class="n">%88</span> <span class="p">=</span> <span class="k">call</span> <span class="k">fast</span> <span class="kt">float</span> <span class="vg">@llvm.experimental.vector.reduce.v2.fadd.f32.v4f32</span><span class="p">(</span><span class="kt">float</span> <span class="m">0.000000e+00</span><span class="p">,</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">%87</span><span class="p">)</span>
  <span class="n">%89</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="n">%10</span><span class="p">,</span> <span class="n">%1</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="n">%89</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%90</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%6</span>

<span class="m">90</span><span class="err">:</span>                                               <span class="c">; preds = %92, %84, %2
</span><span class="c"></span>  <span class="n">%91</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">float</span> <span class="p">[</span> <span class="m">0.000000e+00</span><span class="p">,</span> <span class="n">%2</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%88</span><span class="p">,</span> <span class="n">%84</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%97</span><span class="p">,</span> <span class="n">%92</span> <span class="p">]</span>
  <span class="k">ret</span> <span class="kt">float</span> <span class="n">%91</span>

<span class="m">92</span><span class="err">:</span>                                               <span class="c">; preds = %6, %92
</span><span class="c"></span>  <span class="n">%93</span> <span class="p">=</span> <span class="k">phi</span> <span class="k">i64</span> <span class="p">[</span> <span class="n">%98</span><span class="p">,</span> <span class="n">%92</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%7</span><span class="p">,</span> <span class="n">%6</span> <span class="p">]</span>
  <span class="n">%94</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">float</span> <span class="p">[</span> <span class="n">%97</span><span class="p">,</span> <span class="n">%92</span> <span class="p">],</span> <span class="p">[</span> <span class="n">%8</span><span class="p">,</span> <span class="n">%6</span> <span class="p">]</span>
  <span class="n">%95</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%0</span><span class="p">,</span> <span class="k">i64</span> <span class="n">%93</span>
  <span class="n">%96</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">*</span> <span class="n">%95</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span><span class="p">,</span> <span class="nv">!tbaa</span> <span class="n">!3</span>
  <span class="n">%97</span> <span class="p">=</span> <span class="k">fadd</span> <span class="k">fast</span> <span class="kt">float</span> <span class="n">%96</span><span class="p">,</span> <span class="n">%94</span>
  <span class="n">%98</span> <span class="p">=</span> <span class="k">add</span> <span class="k">nuw</span> <span class="k">i64</span> <span class="n">%93</span><span class="p">,</span> <span class="m">1</span>
  <span class="n">%99</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="k">i64</span> <span class="n">%98</span><span class="p">,</span> <span class="n">%1</span>
  <span class="k">br</span> <span class="k">i1</span> <span class="n">%99</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%90</span><span class="p">,</span> <span class="kt">label</span> <span class="n">%92</span><span class="p">,</span> <span class="nv">!llvm.loop</span> <span class="n">!11</span>
<span class="p">}</span></code></pre></div>
</div>
<button id="button">Expand</button>
</div>
<p>Which&hellip; results in a huge IR because we didn&rsquo;t forbid loop unrolling but it&rsquo;s vis-a-vis what Clang would spit out in C. The important parts are the bunch of 

<code class="language-llvm" data-lang="llvm"><span class="k">fadd</span> <span class="k">fast</span> <span class="p">&lt;</span><span class="m">4</span> <span class="k">x</span> <span class="kt">float</span><span class="p">&gt;</span></code> instructions and the 

    
    
        
        
        
        
    
    

<code class="language-llvm" data-lang="llvm"><span class="vg">@llvm.experimental.vector.reduce.v2.fadd.f32.v4f32</span></code>. These indicate that the flag successfully made LLVM think it&rsquo;s fine to reorder the summation and vectorize the loop.</p>
<p>Note that the idiomatic way of writing this in Rust:
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">summation</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">f32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kt">f32</span> <span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">sum</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div></p>
<p>would produce a different but also vectorized IR.</p>
<h2 id="next">Next</h2>
<p>That was easy. It took me just an afternoon from research and code spelunking to actual implementation. And this is probably one of my highest performance-gained-per-lines-of-code-changed after <a href="https://github.com/rust-lang/rust/pull/78566">Polly</a>.</p>
<p>This is good and all but this <code>-Z</code> flag would blanket apply fast-math to <em>every</em> crate if you switch it on. This lack of specificity could be problematic if you do want fast-math in some hot path in the code but not in other parts maybe because the correctness in them depends on the order of operations or the resulting vectorization causes regression.<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> We remedy this in Part 2.</p>
<div class="pages-list">
<select name="pages" onchange="follow(this)">
    <option value="/posts/rust-fast-math/pt0">Part 0 - Introduction</option>
    <option selected="selected" value="/posts/rust-fast-math/pt1">Part 1 - Global -Z flag</option>
    <option value="/posts/rust-fast-math/pt2">Part 2 - Function attribute</option>
</select>
</div>
<script>
function follow(pages) {
    self.location = pages.options[pages.selectedIndex].value;
}
</script>
<script>
var expanded = false;
const code = document.getElementById("twocol");
const expand_button = document.getElementById("button");
expand_button.addEventListener("click", _ => {
    if (expanded) {
        expanded = false;
        code.classList.toggle("expanded");
        expand_button.textContent = "Expand";
    } else {
        expanded = true;
        code.classList.toggle("expanded");
        expand_button.textContent = "Close";
    }
});
</script><blockquote>
</blockquote>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Which is why, even though useful, this won&rsquo;t be submitted as an MCP. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>
</article>
  </main>
</div>

  
<div class="footer-wrapper">
  <div class="footer-container">
    <div></div>
    <div class="footer-left">
      
      
      
      
      <div class="contact">
        <svg class="svgicon">
          <use href="https://JRF63.github.io/icons.svg#envelope"></use>
        </svg>
        <a class="link" href="mailto:rafael2x0@gmail.com">rafael2x0@gmail.com</a>
      </div>
      
      <div class="contact">
        <svg class="svgicon">
          <use href="https://JRF63.github.io/icons.svg#github"></use>
        </svg>
        <a class="link" href="https://github.com/JRF63">JRF63</a>
      </div>
      
      <div class="contact">
        <svg class="svgicon">
          <use href="https://JRF63.github.io/icons.svg#twitter"></use>
        </svg>
        <a class="link" href="https://www.twitter.com/jrtferrer">jrtferrer</a>
      </div>
      
    </div>
    <div class="footer-right">
      <div class="pizza">🍕</div>
      <a class="link" href="http://buymeacoffee.com/JRF63"><span>Buy me a pizza?</span></a>
    </div>
    <div class="footer-bottom">
      Powered by <a class="link" href="https://gohugo.io"><span>Hugo</span></a>
    </div>
  </div>
</div>
</body>



</html>